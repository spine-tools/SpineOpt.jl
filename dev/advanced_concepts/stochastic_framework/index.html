<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Stochastic Framework · SpineOpt.jl</title><meta name="title" content="Stochastic Framework · SpineOpt.jl"/><meta property="og:title" content="Stochastic Framework · SpineOpt.jl"/><meta property="twitter:title" content="Stochastic Framework · SpineOpt.jl"/><meta name="description" content="Documentation for SpineOpt.jl."/><meta property="og:description" content="Documentation for SpineOpt.jl."/><meta property="twitter:description" content="Documentation for SpineOpt.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/style.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="SpineOpt.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SpineOpt.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../getting_started/installation/">Installation</a></li><li><a class="tocitem" href="../../getting_started/setup_workflow/">Setting up a workflow</a></li><li><a class="tocitem" href="../../getting_started/creating_your_own_model/">Creating Your Own Model</a></li><li><a class="tocitem" href="../../getting_started/archetypes/">Archetypes</a></li><li><a class="tocitem" href="../../getting_started/output_data/">Managing Outputs</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorial/webinars/">Webinars</a></li><li><a class="tocitem" href="../../tutorial/simple_system/">Simple system</a></li><li><a class="tocitem" href="../../tutorial/reserves/">Reserve requirements</a></li><li><a class="tocitem" href="../../tutorial/ramping/">Ramping constraints</a></li><li><a class="tocitem" href="../../tutorial/unit_commitment/">Unit Commitment</a></li><li><a class="tocitem" href="../../tutorial/tutorialTwoHydro/">Two hydro plants</a></li><li><a class="tocitem" href="../../tutorial/case_study_a5/">Case Study A5</a></li></ul></li><li><span class="tocitem">How to</span><ul><li><a class="tocitem" href="../../how_to/change_the_solver/">Change the solver</a></li><li><a class="tocitem" href="../../how_to/define_an_efficiency/">Define an efficiency</a></li><li><a class="tocitem" href="../../how_to/print_the_model/">Print the model</a></li></ul></li><li><span class="tocitem">Concept Reference</span><ul><li><a class="tocitem" href="../../concept_reference/the_basics/">Basics of the model structure</a></li><li><a class="tocitem" href="../../concept_reference/Object Classes/">Object Classes</a></li><li><a class="tocitem" href="../../concept_reference/Relationship Classes/">Relationship Classes</a></li><li><a class="tocitem" href="../../concept_reference/Parameters/">Parameters</a></li><li><a class="tocitem" href="../../concept_reference/Parameter Value Lists/">Parameter Value Lists</a></li></ul></li><li><span class="tocitem">Mathematical Formulation</span><ul><li><a class="tocitem" href="../../mathematical_formulation/variables/">Variables</a></li><li><a class="tocitem" href="../../mathematical_formulation/constraints_automatically_generated/">Constraints</a></li><li><a class="tocitem" href="../../mathematical_formulation/objective_function/">Objective</a></li></ul></li><li><span class="tocitem">Advanced Concepts</span><ul><li><a class="tocitem" href="../temporal_framework/">Temporal Framework</a></li><li class="is-active"><a class="tocitem" href>Stochastic Framework</a><ul class="internal"><li><a class="tocitem" href="#Key-concepts"><span>Key concepts</span></a></li><li><a class="tocitem" href="#General-idea-in-brief"><span>General idea in brief</span></a></li><li><a class="tocitem" href="#Stochastics-in-the-model-data-structure"><span>Stochastics in the model data structure</span></a></li><li><a class="tocitem" href="#Working-with-stochastic-updating-data"><span>Working with stochastic updating data</span></a></li><li><a class="tocitem" href="#Constraint-generation-with-stochastic-path-indexing"><span>Constraint generation with stochastic path indexing</span></a></li></ul></li><li><a class="tocitem" href="../unit_commitment/">Unit Commitment</a></li><li><a class="tocitem" href="../ramping/">Ramping</a></li><li><a class="tocitem" href="../reserves/">Reserves</a></li><li><a class="tocitem" href="../investment_optimization/">Investment Optimization</a></li><li><a class="tocitem" href="../user_constraints/">User Constraints</a></li><li><a class="tocitem" href="../decomposition/">Decomposition</a></li><li><a class="tocitem" href="../powerflow/">PTDF-Based Powerflow</a></li><li><a class="tocitem" href="../pressure_driven_gas_transfer/">Pressure driven gas transfer</a></li><li><a class="tocitem" href="../Lossless_DC_power_flow/">Lossless nodal DC power flows</a></li><li><a class="tocitem" href="../representative_days_w_seasonal_storage/">Representative days with seasonal storages</a></li><li><a class="tocitem" href="../cumulated_flow_restrictions/">Imposing renewable energy targets</a></li><li><a class="tocitem" href="../mga/">Modelling to generate alternatives</a></li><li><a class="tocitem" href="../multi_stage/">Multi-stage optimisation</a></li></ul></li><li><span class="tocitem">Implementation details</span><ul><li><a class="tocitem" href="../../implementation_details/documentation/">Documentation</a></li><li><a class="tocitem" href="../../implementation_details/how_does_the_model_update_itself/">How does the model update itself</a></li><li><a class="tocitem" href="../../implementation_details/how_to_write_a_constraint/">How to write a constraint</a></li><li><a class="tocitem" href="../../implementation_details/time_slices/">Time slices</a></li></ul></li><li><a class="tocitem" href="../../library/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Advanced Concepts</a></li><li class="is-active"><a href>Stochastic Framework</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Stochastic Framework</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/spine-tools/SpineOpt.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/spine-tools/SpineOpt.jl/blob/master/docs/src/advanced_concepts/stochastic_framework.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Stochastic-Framework"><a class="docs-heading-anchor" href="#Stochastic-Framework">Stochastic Framework</a><a id="Stochastic-Framework-1"></a><a class="docs-heading-anchor-permalink" href="#Stochastic-Framework" title="Permalink"></a></h1><p>Scenario-based stochastics in unit commitment and economic dispatch models typically only consider branching scenario trees. However, sometimes the available stochastic data doesn&#39;t span over the entire desired modelling horizon, or all the modelled phenomena. Especially with increasing interest in energy system integration and sector coupling, stochastic data of consistent quality and/or length might be hard to come by.</p><p>While these data issues can be circumvented by either cloning stochastic data across multiple scenario branches or generating dummy forecasts, they can result in inflated problem sizes. Furthermore, Ensuring realistic correlations between generated forecasts is extremely difficult, especially across multiple energy sectors.</p><p>The stochastic framework in <em>SpineOpt.jl</em> aims to support stochastic directed acyclic graphs (DAGs) instead of only branching trees, allowing for scenarios to converge later on in the modelled horizon. In addition, the framework allows for slightly different stochastic scenario graphs for different variables, making it easier to define e.g. variables common between all stochastic scenarios.</p><h2 id="Key-concepts"><a class="docs-heading-anchor" href="#Key-concepts">Key concepts</a><a id="Key-concepts-1"></a><a class="docs-heading-anchor-permalink" href="#Key-concepts" title="Permalink"></a></h2><p>Here, we briefly describe the key concepts required to understand the stochastic framework:</p><ol><li><p><strong><a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a></strong> is essentially just a label for an alternative period of time, describing one possiblity of what may come to pass. Even in deterministic modelling with <em>SpineOpt.jl</em>, a single <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> is required for labelling the deterministic timeline.</p></li><li><p><strong>Stochastic DAG</strong> is the directed acyclic graph describing the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationships between the <code>stochastic scenarios</code>. The key difference between a <em>stochastic DAG</em> and a traditional <em>stochastic tree</em> is that the scenarios are allowed to have multiple parents, making it possible to converge scenarios into each other in addition to branching.</p></li><li><p><strong>Stochastic path</strong> is a unique sequence of <code>stochastic scenarios</code> for traversing the <em>stochastic DAG</em>. Every <em>(finite) stochastic DAG</em> has a limited number of <em>full stochastic paths</em> that traverse it from roots <em>(scenarios without parents)</em> to leaves <em>(scenarios without children)</em>. Here, we use the term <em>stochastic path</em> to refer to any subset of scenarios within a <em>full stochastic path</em>.</p></li><li><p><strong><a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a></strong> is essentially a &quot;realization&quot; of the <em>stochastic DAG</em>, with additional information like the <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> and <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> <a href="../../concept_reference/Parameters/#Parameters">Parameters</a>. These become relevant when we start discussing interactions between different <code>stochastic structures</code>.</p></li></ol><img src="../../figs/dag_fullpath_path.svg" width="40%"/><p>The above figure presents an example <em>stochastic DAG</em> with the individual <code>stochastic scenarios</code> labelled from <code>s0-s8</code>. An example <em>full stochastic path</em> <code>[s0, s1, s5, s8]</code> is highlighted in red, while an example <em>stochastic path</em> <code>[s2, s4, s7]</code> is highlighted in blue.</p><h2 id="General-idea-in-brief"><a class="docs-heading-anchor" href="#General-idea-in-brief">General idea in brief</a><a id="General-idea-in-brief-1"></a><a class="docs-heading-anchor-permalink" href="#General-idea-in-brief" title="Permalink"></a></h2><p>The major issue with <em>stochastic DAGs</em> compared to <em>stochastic trees</em>, is that indexing constraints that include variables from multiple time steps <em>(henceforth referred to as &quot;dynamic constraints&quot;)</em> needs rethinking. With <em>stochastic trees</em>, constraints can always be unambiguously indexed using <code>(stochastic_scenario, last_time_step)</code>, since all <code>stochastic scenarios</code> only have a single parent. However, this is no longer the case for <em>stochastic DAGs</em>, as illustrated in the figures below:</p><img src="../../figs/branching.svg" width="40%"/>
<img src="../../figs/converging.svg" width="40%"/><p>The example on the left illustrates the &quot;traditional&quot; indexing in branching <em>stochastic trees</em>, where backtracking through the tree always leads to unambiguous <code>(stochastic_scenario, time_step)</code> indices. The example on the right shows a similar situation in a <em>stochastic DAG</em>, where backtracking through the DAG leads to four different <code>(stochastic_scenario, time_step)</code> indices, and thus requires four constraints to be generated and indexed.</p><h3 id="Stochastic-path-indexing"><a class="docs-heading-anchor" href="#Stochastic-path-indexing">Stochastic path indexing</a><a id="Stochastic-path-indexing-1"></a><a class="docs-heading-anchor-permalink" href="#Stochastic-path-indexing" title="Permalink"></a></h3><p>As discussed in the previous section, dynamic constraints in <em>stochastic DAGs</em> cannot be unambiguously indexed using a single <code>(stochastic_scenario, time_step)</code>. However, they <em>can</em> be unambiguously indexed using <code>(stochastic_path, time_step)</code>, where the <em>stochastic path</em> is the unique sequence of <code>stochastic scenarios</code> traversing the DAG. Since there are only a limited number of ways to traverse the DAG, represented by the <em>full stochastic paths</em>, we can identify the number of unique paths necessary for constraint generation as follows:</p><ol><li>Identify all unique <em>full stochastic paths</em>, meaning all the possible ways of traversing the DAG from roots to leaves.</li><li>Find all the <code>stochastic scenarios</code> that are active on all the <code>time steps</code> included in the constraint.</li><li>Find all the unique <em>stochastic paths</em> by intersecting the set of active <code>stochastic scenarios</code> with the <em>full stochastic paths</em>.</li><li>Generate constraints over each unique <em>stochastic path</em> found in step 3.</li></ol><h4 id="Example-dynamic-constraint-generation"><a class="docs-heading-anchor" href="#Example-dynamic-constraint-generation">Example dynamic constraint generation</a><a id="Example-dynamic-constraint-generation-1"></a><a class="docs-heading-anchor-permalink" href="#Example-dynamic-constraint-generation" title="Permalink"></a></h4><img src="../../figs/constraint_paths.svg" width="40%"/><p>The above figure shows examples of two different dynamic constraints generated in a <em>stochastic DAG</em>: the red constraint including variables from timesteps <code>t4-t5</code> and the blue constraint including variables from timesteps <code>t1, t3</code>. The <em>full stochastic paths</em> for traversing the above DAG are as follows:</p><ol><li><code>[s0, s1, s5, s8]</code></li><li><code>[s0, s2, s3, s5, s8]</code></li><li><code>[s0, s2, s4, s6, s8]</code></li><li><code>[s0, s2, s4, s7, s8]</code></li></ol><p>For the red constraint, the <code>stochastic scenarios</code> <code>s5-s8</code> are active on the <code>time steps</code> <code>t4-t5</code>. All the above <em>full stochastic paths</em> include at least two of the active <code>stochastic scenarios</code>, but full paths 1 and 2 both produce an identical path <code>[s5, s8]</code>, so the set of unique <em>stochastic paths</em> for the red constraint becomes:</p><ol><li><code>[s5, s8]</code></li><li><code>[s6, s8]</code></li><li><code>[s7, s8]</code></li></ol><p>There are no paths <code>[s5, s6], [s5, s7], [s6, s7]</code> since following the DAG one cannot start from <code>s5</code> and end up in <code>s6</code>, even though these <code>stochastic scenarios</code> are active.</p><p>The blue constraint illustrates a case where the time step range is non-continuous. The active <code>stochastic scenarios</code> on <code>t1, t3</code> are <code>s1, s2, s4, s5</code>, so again by comparing these to the <em>full stochastic paths</em> we get:</p><ol><li><code>[s1, s5]</code></li><li><code>[s2, s5]</code></li><li><code>[s2, s4]</code></li></ol><p>In this case, the <em>full stochastic paths</em> 3 and 4 both produce the path <code>[s2, s4]</code>, so only three unique constraints need to be generated. Again, the path <code>[s1, s4]</code> is invalid, since the DAG cannot be traversed from <code>s1</code> to <code>s4</code>.</p><h3 id="Interaction-between-different-stochastic-structures"><a class="docs-heading-anchor" href="#Interaction-between-different-stochastic-structures">Interaction between different stochastic structures</a><a id="Interaction-between-different-stochastic-structures-1"></a><a class="docs-heading-anchor-permalink" href="#Interaction-between-different-stochastic-structures" title="Permalink"></a></h3><p><em>Stochastic path</em> indexing in constraints also allows for &quot;distorting&quot; the <em>stochastic DAG</em> in different parts of the model. As long as the <em>stochastic DAG</em> itself isn&#39;t changed, meaning the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationships and the resulting <em>full stochastic paths</em>, we can actually define different <code>stochastic structures</code> and still be able to handle constraint generation between them. This is due to the fact that when determining the <em>stochastic paths</em>, it makes no difference whether we&#39;re looking at the same <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> at different <code>time steps</code>, or at two <code>stochastic structures</code>, one of which has been delayed, on the same <code>time step</code>. This is illustrated by the figure below:</p><img src="../../figs/delayed_stochastic_paths.svg" width="50%"/><p>The above represents constraint generation over two <code>stochastic structures</code>, where the lower <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> has been delayed in respect to the one above. Nevertheless, the procedure for finding the <em>stochastic paths</em> for the constraints remains identical to the previous example:</p><ol><li>Identify all unique <em>full stochastic paths</em>, meaning all the possible ways of traversing the DAG. As long as the DAG remains the same between all the involved <code>stochastic structures</code>, the pathing remains the same.</li><li>Find all the <code>stochastic scenarios</code> that are active on all the <code>stochastic structures</code> and <code>time steps</code> included in the constraint.</li><li>Find all the unique stochastic paths by intersecting the set of active scenarios with the <em>full stochastic paths</em>.</li><li>Generate constraints over each unique stochastic path found in step 3.</li></ol><h2 id="Stochastics-in-the-model-data-structure"><a class="docs-heading-anchor" href="#Stochastics-in-the-model-data-structure">Stochastics in the model data structure</a><a id="Stochastics-in-the-model-data-structure-1"></a><a class="docs-heading-anchor-permalink" href="#Stochastics-in-the-model-data-structure" title="Permalink"></a></h2><p>While the <a href="#Key-concepts">Key concepts</a> and <a href="#General-idea-in-brief">General idea in brief</a> sections go over the stochastic framework in <em>SpineOpt.jl</em> in a more general sense, here we&#39;ll go over how to set up stochastics using <em>SpineOpt.jl</em> data structure. Simple step-by-step examples are also provided in the <a href="#Example-of-deterministic-stochastics">Example of deterministic stochastics</a>, <a href="#Example-of-branching-stochastics">Example of branching stochastics</a>, and <a href="#Example-of-converging-stochastics">Example of converging stochastics</a> sections further below. We won&#39;t go into too much detail about the related <a href="../../concept_reference/Object Classes/#Object-Classes">Object Classes</a>, <a href="../../concept_reference/Relationship Classes/#Relationship-Classes">Relationship Classes</a>, or <a href="../../concept_reference/Parameters/#Parameters">Parameters</a>, since those can be found in their respective sections. Introductions to these concepts can also be found in the <a href="../../concept_reference/the_basics/#Structural-object-classes">Structural object classes</a> and <a href="../../concept_reference/the_basics/#Structural-relationship-classes">Structural relationship classes</a> sections, if necessary.</p><h3 id="Setting-up-the-stochastic-framework"><a class="docs-heading-anchor" href="#Setting-up-the-stochastic-framework">Setting up the stochastic framework</a><a id="Setting-up-the-stochastic-framework-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-stochastic-framework" title="Permalink"></a></h3><p>As with all things in <em>SpineOpt.jl</em>, you&#39;ll want to start with adding the desired number of objects to the relevant <a href="../../concept_reference/Object Classes/#Object-Classes">Object Classes</a>, as one cannot define relationships over objects that don&#39;t exist. For the stochastic framework, this means creating at least one <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> and <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> object each. This needs to be done even if your model is fully deterministic, as even the deterministic structure needs to be labelled for <em>SpineOpt.jl</em> to recognize that it exists.</p><p>Next, if your model has multiple <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> objects, you&#39;ll want to define how they are related using the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationship. This relationship essentially defines the <em>stochastic DAG</em>, as well as all the possible <em>stochastic paths</em>, explained in the <a href="#Key-concepts">Key concepts</a> section. Unless the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationship is defined, there won&#39;t be a <em>stochastic DAG</em>, and all <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> objects will be assumed to be completely independent of each other.</p><p>Now that you&#39;ve set up the desired <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> and <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> objects, as well as defined the <em>stochastic DAG</em> using the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationship, it&#39;s time to define the properties of the <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> objects using the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship, and the <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> and <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> <a href="../../concept_reference/Parameters/#Parameters">Parameters</a> therein. You&#39;ll always have to define at least one <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship, as the <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> object is what connects the <a href="../../concept_reference/the_basics/#Systemic-object-classes">Systemic object classes</a> to the stochastic framework. <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship holds two key <a href="../../concept_reference/Parameters/#Parameters">Parameters</a>:</p><ul><li><strong><a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a></strong> defines the coefficient the corresponding <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> has in the <a href="../../mathematical_formulation/objective_function/#Objective-function">Objective function</a>, and needs to be defined for each <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> included in the <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a>. The weight is relative to the parents of the [stochastic_scenario], and is calculated as presented below.</li></ul><pre><code class="nohighlight hljs"># For root `stochastic_scenarios` (meaning no parents)

weight(scenario) = weight_relative_to_parents(scenario)

# If not a root `stochastic_scenario`

weight(scenario) = sum([weight(parent) * weight_relative_to_parents(scenario)] for parent in parents)</code></pre><ul><li><strong><a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a></strong> is a <code>Duration</code> type parameter that tells when the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> ends in relation to the start of the current optimization. When defined, the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> ends at the defined point in time, and spawns its children according to <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a>, if any. <strong>Note that this means the children are included in the <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a>, even without an explicit relationship!</strong> If <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> isn&#39;t defined, the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> is assumed to go on indefinetely.</li></ul><p>Finally, with all the pieces in place, we&#39;ll need to connect the defined <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> objects to the desired objects in the <a href="../../concept_reference/the_basics/#Systemic-object-classes">Systemic object classes</a> using the <a href="../../concept_reference/the_basics/#Structural-relationship-classes">Structural relationship classes</a> like  <a href="../../concept_reference/Relationship Classes/#node__stochastic_structure">node__stochastic_structure</a> etc. Here, we essentially tell which parts of the modelled system use which <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a>. Since creating each of these relationships individually can be a bit of a pain, there are a few <a href="../../concept_reference/the_basics/#Meta-relationship-classes">Meta relationship classes</a> like the <a href="../../concept_reference/Relationship Classes/#model__default_stochastic_structure">model__default_stochastic_structure</a>, that can be used to set <a href="../../concept_reference/Object Classes/#model">model</a>-wide defaults that are used if specific relationships are missing.</p><h3 id="Example-of-deterministic-stochastics"><a class="docs-heading-anchor" href="#Example-of-deterministic-stochastics">Example of deterministic stochastics</a><a id="Example-of-deterministic-stochastics-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-deterministic-stochastics" title="Permalink"></a></h3><p>Here, we&#39;ll demonstrate step-by-step how to create the simplest possible stochastic frame: the fully deterministic one. See the <a href="../../getting_started/archetypes/#Deterministic-Stochastic-Structure">Deterministic Stochastic Structure</a> <a href="../../getting_started/archetypes/#Archetypes">archetype</a> for how the final data structure looks like, as well as how to connect this <code>stochastic_structure</code> to the rest of your model. </p><ol><li>Create a <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> called e.g. <code>realization</code> and a <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> called e.g. <code>deterministic</code>.</li><li>We can skip the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationship, since there isn&#39;t a <em>stochastic DAG</em> in this example, and the default behaviour of each <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> being independent works for our purposes <em>(only one <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> anyhow)</em>.</li><li>Create the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship for <code>(deterministic, realization)</code>, and set its <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> parameter to 1. We don&#39;t need to define the <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> parameter, as we want the <code>realization</code> to go on indefinitely.</li><li>Relate the <code>deterministic</code> <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> to all the desired system objects using the appropriate <a href="../../concept_reference/the_basics/#Structural-relationship-classes">Structural relationship classes</a>, or use the <a href="../../concept_reference/Object Classes/#model">model</a>-level default <a href="../../concept_reference/the_basics/#Meta-relationship-classes">Meta relationship classes</a>.</li></ol><h3 id="Example-of-branching-stochastics"><a class="docs-heading-anchor" href="#Example-of-branching-stochastics">Example of branching stochastics</a><a id="Example-of-branching-stochastics-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-branching-stochastics" title="Permalink"></a></h3><p>Here, we&#39;ll demonstrate step-by-step how to create a simple branching stochastic tree, where one scenario branches into three at a specific point in time. See the <a href="../../getting_started/archetypes/#Branching-Stochastic-Tree">Branching Stochastic Tree</a> <a href="../../getting_started/archetypes/#Archetypes">archetype</a> for how the final data structure looks like, as well as how to connect this <code>stochastic_structure</code> to the rest of your model.</p><ol><li>Create four <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> objects called e.g. <code>realization</code>, <code>forecast1</code>, <code>forecast2</code>, and <code>forecast3</code>, and a <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> called e.g. <code>branching</code>.</li><li>Define the <em>stochastic DAG</em> by creating the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationships for <code>(realization, forecast1)</code>, <code>(realization, forecast2)</code>, and <code>(realization, forecast3)</code>.</li><li>Create the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship for <code>(branching, realization)</code>, <code>(branching, forecast1)</code>, <code>(branching, forecast2)</code>, and <code>(branching, forecast3)</code>.</li><li>Set the <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> parameter to 1 and the <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> parameter e.g. to <code>6h</code> for the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship <code>(branching, realization)</code>. Now, the <code>realization</code> <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> will end after 6 hours of <code>time steps</code>, and its children <em>(<code>forecast1</code>, <code>forecast2</code>, and <code>forecast3</code>)</em> will become active.</li><li>Set the <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> <a href="../../concept_reference/Parameters/#Parameters">Parameters</a> for the <code>(branching, forecast1)</code>, <code>(branching, forecast2)</code>, and <code>(branching, forecast3)</code> <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationships to whatever you desire, e.g. 0.33 for equal probabilities across all forecasts.</li><li>Relate the <code>branching</code> <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> to all the desired system objects using the appropriate <a href="../../concept_reference/the_basics/#Structural-relationship-classes">Structural relationship classes</a>, or use the <a href="../../concept_reference/Object Classes/#model">model</a>-level default <a href="../../concept_reference/the_basics/#Meta-relationship-classes">Meta relationship classes</a>.</li></ol><h3 id="Example-of-converging-stochastics"><a class="docs-heading-anchor" href="#Example-of-converging-stochastics">Example of converging stochastics</a><a id="Example-of-converging-stochastics-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-converging-stochastics" title="Permalink"></a></h3><p>Here, we&#39;ll demonstrate step-by-step how to create a simple <em>stochastic DAG</em>, where both branching and converging occurs. This example relies on the previous <a href="#Example-of-branching-stochastics">Example of branching stochastics</a>, but adds another <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> at the end, which is a child of the <code>forecast1</code>, <code>forecast2</code>, and <code>forecast3</code> scenarios. See the <a href="../../getting_started/archetypes/#Converging-Stochastic-Tree">Converging Stochastic Tree</a> <a href="../../getting_started/archetypes/#Archetypes">archetype</a> for how the final data structure looks like, as well as how to connect this <code>stochastic_structure</code> to the rest of your model.</p><ol><li>Follow the steps 1-5 in the previous <a href="#Example-of-branching-stochastics">Example of branching stochastics</a>, except call the <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> something different, e.g. <code>converging</code>.</li><li>Create a new <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> called e.g. <code>converged_forecast</code>.</li><li>Alter the <em>stochastic DAG</em> by creating the <a href="../../concept_reference/Relationship Classes/#parent_stochastic_scenario__child_stochastic_scenario">parent_stochastic_scenario__child_stochastic_scenario</a> relationships for <code>(forecast1, converged_forecast)</code>, <code>(forecast2, converged_forecast)</code>, and <code>(forecast3, converged_forecast)</code>. Now all three forecasts will converge into a single <code>converged_forecast</code>.</li><li>Add the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationship for <code>(converging, converged_forecast)</code>, and set its <a href="../../concept_reference/Parameters/#weight_relative_to_parents">weight_relative_to_parents</a> parameter to 1. Now, all the probability mass in <code>forecast1</code>, <code>forecast2</code>, and <code>forecast3</code> will be summed up back to the <code>converged_forecast</code>.</li><li>Set the <a href="../../concept_reference/Parameters/#stochastic_scenario_end">stochastic_scenario_end</a> <a href="../../concept_reference/Parameters/#Parameters">Parameters</a> of the <a href="../../concept_reference/Relationship Classes/#stochastic_structure__stochastic_scenario">stochastic_structure__stochastic_scenario</a> relationships <code>(converging, forecast1)</code>, <code>(converging, forecast2)</code>, and <code>(converging, forecast3)</code> to e.g. <code>1D</code>, so that all three scenarios end at the same time and the <code>converged_forecast</code> becomes active.</li><li>Relate the <code>converging</code> <a href="../../concept_reference/Object Classes/#stochastic_structure">stochastic_structure</a> to all the desired system objects using the appropriate <a href="../../concept_reference/the_basics/#Structural-relationship-classes">Structural relationship classes</a>, or use the <a href="../../concept_reference/Object Classes/#model">model</a>-level default <a href="../../concept_reference/the_basics/#Meta-relationship-classes">Meta relationship classes</a>.</li></ol><h2 id="Working-with-stochastic-updating-data"><a class="docs-heading-anchor" href="#Working-with-stochastic-updating-data">Working with stochastic updating data</a><a id="Working-with-stochastic-updating-data-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-stochastic-updating-data" title="Permalink"></a></h2><p>Now that we&#39;ve discussed how to set up stochastics for SpineOpt, let&#39;s focus on stochastic data. The most complex form of input data SpineOpt can currently handle is both <em>stochastic</em> and <em>updating</em>, meaning that the values the parameter takes can depend on both the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a>, and the <em>analysis time (first time step)</em> of each solve. However, just <em>stochastic</em> or just <em>updating</em> cases are supported as well, using the same input data format.</p><p>In SpineOpt, stochastic data uses the <code>Map</code> data type from <a href="https://github.com/Spine-project/SpineInterface.jl"><em>SpineInterface.jl</em></a>. Essentially, <code>Maps</code> are general indexed data containers, which SpineOpt tries to interpret as stochastic data. Every time SpineOpt calls a parameter, it passes the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> and <em>analysis time</em> as keyword arguments to the parameter, but depending on the parameter type, it doesn&#39;t necessarily do anything with that information. For <code>Map</code> type parameters, those keyword arguments are used for navigating the indices of the <code>Map</code> to try and find the corresponding value. If the <code>Map</code> doesn&#39;t include the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> index it&#39;s looking for, it assumes there&#39;s no <em>stochastic</em> information in the <code>Map</code> and carries on to search for <em>analysis time</em> indices. This logic is useful for defining both <em>stochastic</em> and <em>updating</em> data, as well as either case by itself, as shown in the following examples.</p><h3 id="Example-of-stochastic-data"><a class="docs-heading-anchor" href="#Example-of-stochastic-data">Example of stochastic data</a><a id="Example-of-stochastic-data-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-stochastic-data" title="Permalink"></a></h3><p>By <em>stochastic data</em>, we mean parameter values that depend only on the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a>. In such a case, the input data must be formatted as a <code>Map</code> with the following structure</p><table><tr><th style="text-align: right"><a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a></th><th style="text-align: right">value</th></tr><tr><td style="text-align: right"><code>scenario1</code></td><td style="text-align: right"><code>value1</code></td></tr><tr><td style="text-align: right"><code>scenario2</code></td><td style="text-align: right"><code>value2</code></td></tr></table><p>where <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> indices are simply <code>Strings</code> corresponding to the names of the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> objects. The <em>values</em> can be whatever data types <a href="https://github.com/Spine-project/SpineInterface.jl"><em>SpineInterface.jl</em></a> supports, like <code>Constants</code>, <code>DateTimes</code>, <code>Durations</code>, or <code>TimeSeries</code>. In the above example, the parameter will take <code>value1</code> in <code>scenario1</code>, and <code>value2</code> in <code>scenario2</code>. Note that since there&#39;s no <em>analysis time</em> index in this example, the <em>values</em> are used regardless of the <em>analysis time</em>.</p><h3 id="Example-of-updating-data"><a class="docs-heading-anchor" href="#Example-of-updating-data">Example of updating data</a><a id="Example-of-updating-data-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-updating-data" title="Permalink"></a></h3><p>By <em>updating data</em>, we mean parameter values that depend only on the <em>analysis time</em>. In such a case, the input data must be formatted as a <code>Map</code> with the following structure</p><table><tr><th style="text-align: right">analysis time</th><th style="text-align: right">value</th></tr><tr><td style="text-align: right"><code>2000-01-01T00:00:00</code></td><td style="text-align: right"><code>value1</code></td></tr><tr><td style="text-align: right"><code>2000-01-01T12:00:00</code></td><td style="text-align: right"><code>value2</code></td></tr></table><p>where the <em>analysis time</em> indices are <code>DateTime</code> values. The <em>values</em> can be whatever data types <a href="https://github.com/Spine-project/SpineInterface.jl"><em>SpineInterface.jl</em></a> supports, like <code>Constants</code>, <code>DateTimes</code>, <code>Durations</code>, or <code>TimeSeries</code>. In the above example, the parameter will take <code>value1</code> if the first time step of the current simulation is between <code>2000-01-01T00:00:00</code> and <code>2000-01-01T12:00:00</code>, and <code>value2</code> if the first time step of the simulation is after <code>2000-01-01T12:00:00</code>. Note that since there&#39;s no <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> index in this example, the <em>values</em> are used regardless of the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a>.</p><h3 id="Example-of-stochastic-updating-data"><a class="docs-heading-anchor" href="#Example-of-stochastic-updating-data">Example of stochastic updating data</a><a id="Example-of-stochastic-updating-data-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-stochastic-updating-data" title="Permalink"></a></h3><p>By <em>stochastic updating data</em>, we mean parameter values that depend on both the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> and the <em>analysis time</em>. In such a case, the input data must be formatted as a <code>Map</code> with the following structure</p><table><tr><th style="text-align: right"><a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a></th><th style="text-align: right">analysis time</th><th style="text-align: right">value</th></tr><tr><td style="text-align: right"><code>scenario1</code></td><td style="text-align: right"><code>2000-01-01T00:00:00</code></td><td style="text-align: right"><code>value1</code></td></tr><tr><td style="text-align: right"><code>scenario1</code></td><td style="text-align: right"><code>2000-01-01T12:00:00</code></td><td style="text-align: right"><code>value2</code></td></tr><tr><td style="text-align: right"><code>scenario2</code></td><td style="text-align: right"><code>2000-01-01T00:00:00</code></td><td style="text-align: right"><code>value3</code></td></tr><tr><td style="text-align: right"><code>scenario2</code></td><td style="text-align: right"><code>2000-01-01T12:00:00</code></td><td style="text-align: right"><code>value4</code></td></tr></table><p>where the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> indices are simply <code>Strings</code> corresponding to the names of the <a href="../../concept_reference/Object Classes/#stochastic_scenario">stochastic_scenario</a> objects, and the <em>analysis time</em> indices are <code>DateTime</code> values. The <em>values</em> can be whatever data types <a href="https://github.com/Spine-project/SpineInterface.jl"><em>SpineInterface.jl</em></a> supports, like <code>Constants</code>, <code>DateTimes</code>, <code>Durations</code>, or <code>TimeSeries</code>. In the above example, the parameter will take <code>value1</code> if the first time step of the current simulation is between <code>2000-01-01T00:00:00</code> and <code>2000-01-01T12:00:00</code> and the parameter is called in <code>scenario1</code>, and <code>value3</code> in <code>scenario2</code>. If the first time step of the current simulation is after <code>2000-01-01T12:00:00</code>, the parameter will take <code>value2</code> in <code>scenario1</code>, and <code>value4</code> in <code>scenario2</code>.</p><h2 id="Constraint-generation-with-stochastic-path-indexing"><a class="docs-heading-anchor" href="#Constraint-generation-with-stochastic-path-indexing">Constraint generation with stochastic path indexing</a><a id="Constraint-generation-with-stochastic-path-indexing-1"></a><a class="docs-heading-anchor-permalink" href="#Constraint-generation-with-stochastic-path-indexing" title="Permalink"></a></h2><p>Every time a constraint might refer to variables either on different time steps or on different <code>stochastic scenarios</code> (meaning different <code>nodes</code> or <code>units</code>), the constraint needs to use stochastic path indexing in order to be correctly generated for arbitrary stochastic DAGs. In practise, this means following the procedure outlined below:</p><ol><li>Identify all unique <em>full stochastic paths</em>, meaning all the possible ways of traversing the DAG. This is done along with generating the stochastic structure, so no real impact on constraint generation.</li><li><strong>Find all the <code>stochastic scenarios</code> that are active on all the <code>stochastic structures</code> and <code>time slices</code> included in the constraint.</strong></li><li><strong>Find all the unique stochastic paths by intersecting the set of active scenarios with the <em>full stochastic paths</em>.</strong></li><li>Generate constraints over each unique stochastic path found in step 3.</li></ol><p>Steps 2 and 3 are the crucial ones, and are currently handled by separate <code>constraint_&lt;constraint_name&gt;_indices</code> functions. Essentially, these functions go through all the variables on all the time steps included in the constraint, collect the set of active <code>stochastic_scenarios</code> on each time step, and then determine the unique active stochastic paths on each time step. The functions pre-form the index set over which the constraint is then generated in the <code>add_constraint_&lt;constraint_name&gt;</code> functions.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../temporal_framework/">« Temporal Framework</a><a class="docs-footer-nextpage" href="../unit_commitment/">Unit Commitment »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.0 on <span class="colophon-date" title="Thursday 18 April 2024 14:38">Thursday 18 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
